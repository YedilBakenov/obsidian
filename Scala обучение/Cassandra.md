#scalaобучение 

### Apache Cassandra: Полное руководство

**Apache Cassandra** — это распределённая, горизонтально масштабируемая база данных с открытым исходным кодом, созданная для хранения и обработки огромных объёмов данных с высокой доступностью и отказоустойчивостью. Она была разработана для того, чтобы быть **мастер-мастер** (masterless) базой данных, что означает, что все узлы в кластере равноправны, и нет единой точки отказа (single point of failure).

Cassandra используется для построения систем, которые могут обрабатывать большое количество операций записи и чтения в реальном времени, распределённых по множеству узлов, расположенных по всему миру. Она также обеспечивает возможность работы с большими объёмами данных и параллельной обработки запросов без потери производительности.

### Особенности и ключевые концепции Apache Cassandra

1. **Мастер-мастер репликация**: В Cassandra нет выделенного ведущего узла (master). Каждый узел равноправен, и любой узел может принимать запросы на запись или чтение. Это означает, что если один узел выходит из строя, другие узлы могут продолжать работу без потери данных или доступности.
    
2. **Скалируемость по горизонтали**: Cassandra масштабируется горизонтально, что означает, что для увеличения производительности вы можете просто добавить больше узлов в кластер. Это особенно полезно для работы с большими объёмами данных и высокой частотой запросов.
    
3. **Высокая доступность и отказоустойчивость**: Cassandra автоматически реплицирует данные на несколько узлов для обеспечения отказоустойчивости. Даже если один или несколько узлов выходят из строя, данные остаются доступными на других узлах.
    
4. **Запись без блокировок**: Cassandra поддерживает высокую скорость записи данных за счёт использования механизма "писать вперёд" (write-ahead logging) и SSTable (Sorted String Table), что позволяет записывать данные последовательно, избегая блокировок.
    
5. **Гибкая схема (schema-less)**: Cassandra не требует жёсткой схемы, как реляционные базы данных. Это позволяет динамически изменять структуру данных без необходимости остановки системы для миграций.
    
6. **Транзакции с лёгкими условиями (lightweight transactions)**: Cassandra поддерживает ограниченные транзакции с возможностью выполнения условий, например, сравнения и замены данных (CAS — Compare-And-Set).
    
7. **Consistent Hashing**: Для распределения данных Cassandra использует алгоритм **consistent hashing**. Это позволяет легко распределять и хранить данные по узлам, избегая перегрузки отдельных узлов при добавлении новых.
    

### Архитектура Cassandra

1. **Кластеры и узлы**: Cassandra работает как кластер, состоящий из множества узлов. Все узлы равноправны, и данные распределяются между ними с помощью хеш-функции. Кластер может быть географически распределён, что означает, что узлы могут находиться в разных дата-центрах.
    
2. **Токены и партиции**: Данные в Cassandra хранятся в виде ключ-значение. Каждое значение привязывается к **партиционному ключу** (partition key), который с помощью хеш-функции преобразуется в **токен**. Токены распределяются по узлам, что помогает равномерно распределить нагрузку и данные между узлами.
    
3. **Репликация данных**: Каждый узел в Cassandra хранит только часть данных. Однако данные реплицируются на несколько узлов для обеспечения отказоустойчивости. Параметр **Replication Factor** определяет, на скольких узлах должны храниться копии данных. Например, если replication factor = 3, данные будут реплицированы на три разных узла.
    
4. **Модели консистентности**: Cassandra поддерживает настройку уровней консистентности:
    
    - **ONE**: Данные считаются записанными, если они записаны хотя бы на одном узле.
    - **QUORUM**: Данные считаются записанными, если они записаны на большинстве (quorum) узлов.
    - **ALL**: Данные считаются записанными, если они записаны на всех узлах.
    
    Это позволяет гибко выбирать между консистентностью и доступностью в зависимости от конкретных требований приложения.
    

### Работа с данными в Cassandra

1. **Создание ключевого пространства (Keyspace)**: Ключевое пространство в Cassandra — это аналог базы данных в реляционных СУБД. Оно содержит таблицы и определяет параметры репликации для этих таблиц.
    
    Пример создания ключевого пространства:
CREATE KEYSPACE my_keyspace WITH replication = {
  'class': 'SimpleStrategy',
  'replication_factor': 3
};


- В данном примере ключевое пространство `my_keyspace` будет иметь репликацию с фактором 3 (данные будут реплицированы на три узла).
    
- **Создание таблицы**: Таблицы в Cassandra имеют структуру с колонками и строками, однако данные хранятся по принципу ключ-значение. При создании таблицы необходимо указать **партиционный ключ**, который используется для распределения данных по узлам.
    
    Пример создания таблицы:
CREATE TABLE users (
  user_id UUID PRIMARY KEY,
  name TEXT,
  age INT,
  email TEXT
);


**Запись данных**: Cassandra обеспечивает высокую скорость записи за счёт того, что данные пишутся в **commit log**и одновременно добавляются в **memtable** (временное хранилище в памяти). Когда memtable достигает определённого размера, данные записываются на диск в виде SSTables.

Пример вставки данных:

INSERT INTO users (user_id, name, age, email)
VALUES (uuid(), 'John Doe', 30, 'john.doe@example.com');


**Чтение данных**: Cassandra обеспечивает эффективное чтение данных за счёт использования индексов и распределения данных по узлам. Когда запрос на чтение поступает на один из узлов, этот узел может либо обработать запрос, если данные находятся на нём, либо передать его другим узлам.

Пример запроса на чтение данных:

SELECT * FROM users WHERE user_id = <uuid>;


**Транзакции в Cassandra**: Cassandra не поддерживает полноценные ACID-транзакции, как реляционные базы данных, однако она предоставляет механизм лёгких транзакций, которые позволяют выполнять операции с условиями (например, CAS — Compare-And-Set).

Пример условной вставки данных:

INSERT INTO users (user_id, name, age, email)
VALUES (uuid(), 'Jane Doe', 25, 'jane.doe@example.com')
IF NOT EXISTS;


Когда использовать Cassandra?

Cassandra идеально подходит для следующих сценариев:

1. **Масштабируемые системы с большим объёмом данных**: Cassandra позволяет хранить и обрабатывать большие объёмы данных за счёт горизонтального масштабирования. Это делает её идеальной для приложений, которые генерируют большие объёмы данных, таких как логирование, аналитика, IoT, и социальные сети.
    
2. **Приложения с высоким количеством операций записи**: Cassandra оптимизирована для высокой скорости записи данных, что делает её подходящей для систем, где пишущие операции происходят часто (например, системы мониторинга, системы учёта событий).
    
3. **Глобально распределённые системы**: Cassandra поддерживает репликацию данных в разных дата-центрах по всему миру. Это делает её подходящей для приложений, которым нужна низкая задержка и высокая доступность на глобальном уровне.
    
4. **Отказоустойчивые системы**: Cassandra может работать даже при отказе части узлов, что делает её подходящей для критически важных систем, где отказ системы недопустим.
    

### Примеры использования Apache Cassandra

1. **Netflix**: Netflix использует Cassandra для хранения данных о пользователях и их активности. Масштабируемость Cassandra позволяет хранить огромные объёмы данных о просмотрах видео и рекомендациях с минимальными задержками.
    
2. **Instagram**: Instagram использует Cassandra для хранения и управления активностью пользователей, такой как лайки, комментарии и подписки. Cassandra помогает обрабатывать миллионы операций в реальном времени с высокой скоростью.
    
3. **Uber**: Uber использует Cassandra для управления геоданными и трекингом поездок. Система должна быть масштабируемой и отказоустойчивой, так как приложение работает в глобальном масштабе.
    

### Заключение

Apache Cassandra — это мощная, масштабируемая и отказоустойчивая база данных, предназначенная для распределённых систем с большими объёмами данных. Она особенно полезна для приложений, которым требуются высокая скорость записи, глобальная репликация и способность работать в условиях высоких нагрузок.