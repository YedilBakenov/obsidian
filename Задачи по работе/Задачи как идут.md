#work 
#task

Тестить задачи по максимуму!

1. Изменение способа оплаты
		1. При создании в боди в name идет Some или None - так не должно быть
2. Также в family в id идет не то значение, не идет ownerPhone - скорее всего проблема в витрине.
Также возможно придется заполнять данный параметр в кассандру и в таблицу с изменением заказа, проверить другие параметры чтобы узнать в какой это находится таблице

нужно посмотреть внимательно конвектер там логику для метода гет

нужно внимательно просмотреть про передачу параметра с номером телефона

уточнить у Ромы как он делал с изменением способа оплаты, 
также посмотреть в jira прошлый код с этой задачей

можно дергать запрос через http на коре можно найти через ownerPhone, но Дима говорит добавить в протоспеку, куда я уже добавлял только в мессадж

ClientOrdersProto так звучит на протоспеках, там находятся все параметры

ClientOrdersEnvelope - класс который генерится с прото-спек и через который можно дергать все параметры

final case class FamilyAccountReference
ownerClientId

В коре принял параметры, теперь осталось подтянуть прото-спеку на клиет-ордер-шовкейс и там обработать данный параметр ownerPhone

В трех сервисах Дима упоминал надо указать параметры

также разобраться с методом гет на витрине

Несоответствия требующие исправления:

1. В ответ на `POST /api/client/mobile/v2/orders`
    
    1. для `“kind": "cash"` возвращается `"name": "None"`
        
    2. для `“kind": "contractor"`, `“kind": "family"`, `“kind": "card"` возвращается `"name": "Some(contractor_name)"`, `"name": "Some(family_name)"`, `"name": "Some(card_name)"`


	Дма говрит что метод get ничего не знает о payment методе

1. В ответ на `GET /api/client/mobile/v2/orders/:orderid` для `“kind": "family"`:
    
    1. в `name` содержится номер карты, а не последние 4 цифры номера владельца семейного аккаунта.
        
    2. в `id` содержится ID способа оплаты

2. эпик с добавлением картинки
    ошибка может быть и на клиент-ауз-сервисе
     нужно поласть запрос ClientAppProfilesEditZoneTariff10 и также getZoneTariff на получение верных настроек. 
     также подойти к Тамаре если что-то не будет получаться и она должна подсказать как загружать картинку mapCarImageMask

![[Снимок экрана 2024-05-21 175756.png]]
		

3. Задачи по Кафке - внимательно прочитать про кафку и в классе правильно указываешь и менять импорты и также логику - разобраться 	


в витрине есть метод getOrder - который достает вроде бы заказ

OrderWithModified

тоже надо прописать такие же условия как и в коре на проверку всех параметров

familyAccountOwnerIdRef
b2BReference


кард пеймент аловед можно достать запросом:

https://gitlab.com/hivetaxi/specs/http-specs-gw-client/-/blob/main/specs/payments-openapi.yaml

с этой спеки

Посмотреть как в коре сетится payment метод, 
скорее всего неправильно, возможно там не отрабатывается способ оплаты family, то добавить его

где-то где утилс, ордер снапшот, там и сетится паймент метод

toDto - это ответ на гет 

скорее всего не надо было прописывать новый параметр в прото спеки, но оставить, если что также будем их использовать другой раз


Дима обратил внимание на этот метод в витрине:

private def toClientOrderPaymentMethod(o: OrderUpdate): ClientOrderPaymentMethod =  
  o.paymentMethod.map(p => ClientOrderPaymentMethod(p.kind, p.id, p.name)).getOrElse(ClientOrderPaymentMethod("", None, None))
  
  final case class ClientOrderPaymentMethod(  
  kind: String,  
  id: Option[String],  
  name: Option[String]  
) extends Udt

посмотреть кто использует данный класс - было в рассуждениях с Димой


def getOrderHistory(clientId: String, orderId: String): EitherT[F, OrderError, (ClientOrderDetailsModel, ReceiptDto)] =  
  for {  
    details    <- daoOrderDetails.get(clientId, orderId).toEitherT(OrderError.OrderNotFound.cast)  
    receiptDto <- EitherT.right(xlebowskiEndpointT.getReceiptUrl(referenceId = orderId))  
    paymentMethod = details.cost.paymentMethod  
    amountVat <- getAmountWithVat(paymentMethod.id, orderId, paymentMethod.kind)  
  } yield {  
    val correctedPaymentMethod = if (paymentMethod.kind === family) ClientOrderPaymentMethod(family, None, None) else paymentMethod  
    (details.copy(cost = details.cost.copy(paymentMethod = correctedPaymentMethod)).toModel(amountVat), receiptDto)  
  }


private def rewritePaymentMethodOrder(data: OrdersStream.OrdersData): ClientOrderDetails = {  
  val paymentMethod                                    = data.details.cost.paymentMethod  
  val correctedPaymentMethod: ClientOrderPaymentMethod = data.familyAccountOwnerIdRef.fold(paymentMethod)(_ => paymentMethod.copy(kind = family))  
  data.details.copy(cost = data.details.cost.copy(paymentMethod = correctedPaymentMethod))  
}




клиентордершовкейс:

Последние изменения в коммите лишние

Нет: B2b конвертер только для b2b заказов, в familyAccountReference точно будет None

![](https://ca.slack-edge.com/T3R2820PL-UDJ4DHQKY-g46e3ac1e30f-48)


Новый ownerPhone пока не нужен


скорее всего ошибка в коре, нужно найти место когда добавляется объект в базу данных. Как он складывается и какие данные будут у него в тот момтент  id и name


ClientOrdersEnvelope






По изменению способа оплаты: 
При выбранном способе оплаты картой и конктрактором нельзя создать заказа кэшем через приложение