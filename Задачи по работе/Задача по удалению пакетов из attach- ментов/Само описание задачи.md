https://hivetaxi.atlassian.net/browse/HD-7761

## Abstract

Если не загрузить в пакет attachment, то он не удаляется как для драфта, так и для заявки

## Solution

Шаг 1: Реализовать связку в **Redis**

Сделаем обратное отображение мапы ключей Redis  
Сейчас есть:

```
pckg -> user_id
pckg -> ticket_id
```

Добавляем

user_id -> pckg Драфты

ticket_id -> pckg Заявки

Чтобы добавить к ключу используем команду _Redis_ **APPEND:**

RedisCommands

```
def append[F[_]: RedisCtx](key: String, value: String): F[Long] = 
  RedisCtx[F].keyed(key, NEL.of("APPEND", key.encode, value.encode))
```


Реализовать двухстороннюю мапу можно в FilesDao в соответствующих методах чтобы скрыть детали реализации

Шаг 2: Вычитать данные из Redis чтобы отправить в Storage запросы на удаление

Теперь мы можем отправить запрос на удаление списка пакетов, когда закачивается жизненный цикл драфта или заявки.   
Изменения затрагивают все стримы в region.intercity.messaging.streams

PackageEventEnvelopeConsumer: Удаляем ключ из новой мапы, потому что пакет был загружен и его не нужно удалять(он удалится вместе с удалением самого attachment-а)

TicketLifecycleConsumer && TicketDraftLifecycleConsumer: Достаем по ключу все пакеты и отправляем запросы в Storage на удаление пакетов


Как тестировать:

Если мы отправили запрос на получение ссылки для загрузки атачей  
`/api/client/mobile/v2/intercity/client-ticket-draft/attachments`  
но не загрузили атачи, при удалении драфта/заявки должен ли удаляться `package` из сторожа

Именно если мы не загрузили ничего в package

![[Pasted image 20241211162427.png]]

А `is_closed` **имеет** `False` **имеет когда мы в него ничего не загрузили**

Посылать на удаление в Storage в стримах
Также удаление должно происходить на стримах
Удаление также должно происходить на сервисе водителей и клиентов при финализации - также посылать запрос на удаление в FilesDao
Удаление пакетов должно происходить при удалении клиентской и водительской заявок, которые я делал ранее

Там мы должны удалять через сторадж ендпоинт

Просмотреть тесты по финализации драфта и удалении и там подумать



надо добавить при putDraft добавление 5 секунд dt

test("Storage Test: links should flatten [2]") { 
_ <- producer.send("test", packageClosed(packageId)) - после должны удалиться пакеты


также когда удаляем через сторадж ендпоинт удаление нужно также через Files

также добавить тесты на удаление конкретных пакетов

